<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        <link rel="canonical" href="http://docs.upyun.com/misc/discuz/">
        <link rel="shortcut icon" href="../../img/favicon.ico">

        <title>又拍云文档中心</title>

        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../../css/prettify.css" rel="stylesheet">
        <link href="../../css/main.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
    </head>

    <body>

        <div class="navbar navbar-upyun" role="navigation">
    <div class="container clearfix">
        <div class="navbar-header">
            <a class="navbar-brand" href="https://www.upyun.com/">又拍云文档中心</a>
        </div>

        <div class="navbar-collapse collapse pull-right">
            <ul class="nav navbar-nav">
            
              <li class="pull-left">
                
                <a href="">文档首页</a>
                
              </li>
            
              <li class="pull-left">
                
                <a href="cdn/">CDN</a>
                
              </li>
            
              <li class="pull-left">
                
                <a href="live/Introduction/">直播</a>
                
              </li>
            
              <li class="pull-left">
                
                <a href="video/">点播&短视频</a>
                
              </li>
            
              <li class="pull-left">
                
                <a href="api/">云存储</a>
                
              </li>
            
              <li class="pull-left">
                
                <a href="cloud/">云处理</a>
                
              </li>
            
              <li class="pull-left">
                
                <a href="ai/audit/">人工智能</a>
                
              </li>
            
              <li class="pull-left">
                
                <a href="download/">SDK&工具</a>
                
              </li>
            
              <li class="pull-left">
                
                <a href="faq/">常见问题</a>
                
              </li>
            
                <li>
                    <a href="https://segmentfault.com/upyun" target="_blank">技术问答</a>
                </li>
            </ul>

            <ul class="list-unstyled navbar-right clearfix">
                <li class="login"><a href="https://console.upyun.com/#/login/">登录</a></li>
                <li class="reg"><a href="https://console.upyun.com/#/register/">注册</a></li>
            </ul>
        </div>
    </div>
</div>


        <div class="container" id="main-wrapper">
            <div class="toolbar clearfix">
  <ol class="breadcrumb pull-left">
    <li><a href="">文档</a></li>
    <li>Discuz</li>
  </ol>

  
    
      <a href="https://github.com/upyun/docs/" class="github-edit pull-right"><i class="fa fa-github"></i> Edit on GitHub</a>
    
  

</div>
            <div class="bs-sidebar hidden-print toc"  data-spy="affix" data-offset-top="120" role="complementary">
  <ul class="nav bs-sidenav">
    
      

    
      
        
      

    
      
        
      

    
      
        
      

    
      
        
      

    
      
        
      

    
      
        
      

    
      
        
      

    
      
        
      

    
  </ul>


</div>



            <div class="content-body" role="main">

<h1>Discuz</h1>

<p>Discuz 用户需要使用 UPYUN 有以下两个方法：</p>
<h2 id="_1">通过论坛自带的远程附件功能<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>使用 Discuz 的远程附件功能，可将论坛附件全部存放到 UPYUN 上。</p>
<p><strong>具体可按如下步骤：</strong></p>
<ol>
<li>
<p>前期准备：</p>
<ul>
<li>
<p>在 UPYUN 上创建一个文件类空间。 注意：必须是文件类空间，不能是图片类空间，discuz 附件含多种类型文件</p>
</li>
<li>
<p>获取空间的 FTP 帐号信息。</p>
</li>
</ul>
</li>
<li>
<p>设置步骤：</p>
<p>注：目前版本的 discuz 绑定 UPYUN，经过 discuz 官方测试，须增加 2 行测试代码，discuz 官方已在最新的版本中增加，会在下次发布时更新。</p>
<p>目前您可以手动修改代码或跳过测试远程附件即可。 手动添加方法见帖子最后。</p>
<p>在论坛后台找到设置远程附件功能，管理后台 =&gt; 全局 =&gt; 上传设置（或附件设置） =&gt; 远程附件：选择“启用远程附件”，然后设置 FTP 帐号信息，如下图所示：
<img alt="" src="https://upyun-assets.b0.upaiyun.com/docs/misc/dz.png" /></p>
</li>
<li>
<p>论坛原有的附件处理</p>
<p>如果您想把论坛原有的附件也搬到 UPYUN，您只要 2 步操作：</p>
<p>a、把原有附件通过 FTP 上传到云存储空间的相应位置</p>
<p>b、把附件表的 remote 字段的属性改为 1</p>
</li>
<li>
<p>到这一步，恭喜您，您的附件已经托管到 UPYUN，这下您不用担心附件的安全及性能问题了。</p>
</li>
</ol>
<p><strong>附录一：</strong></p>
<ul>
<li>
<p>手动修改测试程序代码：</p>
<p>打开：source/admincp/admincp_checktools.php</p>
</li>
<li>
<p>找到：</p>
</li>
</ul>
<pre><code class="language-php">function getremotefile($file) {

    global $_G;

    @set_time_limit(0);

    $str = @implode('', @file($file));

    if(!$str) {

        $str = dfsockopen($file);

    }

    return $str;

}
</code></pre>
<p>替换为：</p>
<pre><code class="language-php">function getremotefile($file) {

    global $_G;

    $file = $file.'?'.rand();

    @set_time_limit(0);

    $str = @implode('', @file($file));

    if(!$str) {

        $str = dfsockopen($file);

    }

    return $str;

}
</code></pre>
<ul>
<li>找到</li>
</ul>
<pre><code class="language-php">ftpcmd('delete', $testfile);
</code></pre>
<p>增加一行:</p>
<pre><code class="language-php">ftpcmd('delete', 'test/index.htm');
</code></pre>
<h2 id="upyun">安装使用 UPYUN 官方插件<a class="headerlink" href="#upyun" title="Permanent link">&para;</a></h2>
<h3 id="discuz-x3x31x32">Discuz X3、X3.1、X3.2<a class="headerlink" href="#discuz-x3x31x32" title="Permanent link">&para;</a></h3>
<h4 id="_2">插件下载<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<ul>
<li>最新版插件(v1.0) 下载：<a href="https://github.com/upyun/discuz-plugin">Github</a></li>
<li>最新版插件(v1.0) 安装使用手册下载：<a href="http://upyun-assets.b0.upaiyun.com/docs/discuz-plugin/Discuz%20%E8%AE%BA%E5%9D%9B%20UPYUN%20%E6%8F%92%E4%BB%B6%20-%20v1.0.pdf">Pdf 版</a> | <a href="http://upyun-assets.b0.upaiyun.com/docs/discuz-plugin/Discuz%20%E8%AE%BA%E5%9D%9B%20UPYUN%20%E6%8F%92%E4%BB%B6-v1.0.zip">Html 版</a></li>
</ul>
<h4 id="_3">版本更新说明<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<p><strong>v1.0 更新说明</strong></p>
<ul>
<li>不兼容 v0.1 版本</li>
<li>简化配置，不再区分文件和图片空间。UPYUN 合并了文件和图片空间</li>
<li>增加分块上传支持，大大提升上传的稳定性和速度</li>
<li>增加 Discuz X3.1 和 X3.2 版本的支持</li>
<li>取消本地图片和文件的备份</li>
<li>优化 Token 防盗链（需要将论坛域名绑定到 UPYUN 空间）</li>
</ul>
<p><strong>v0.1 更新说明</strong></p>
<ul>
<li>代替原有远程附件繁琐的设置步骤，仅需在插件中设置空间，操作员，密码等信息即可使用 UPYUN 服务；</li>
<li>将 Discuz 自带的 FTP 上传核心整体替换成 HTTP 上传，提升上传速度、稳定性和兼容性；</li>
<li>解决部分客户由于虚拟主机权限限制导致无法使用 Discuz 自带 FTP 远程附件的问题；</li>
<li>上传的图片和文件分空间存放，并可指定不同域名；</li>
<li>解决下载论坛非图片附件二次流量问题；</li>
<li>支持本地图片、文件备份；</li>
<li>非图片附件支持 token 防盗链；</li>
<li>附带 API 接入点测速小工具；</li>
<li>增加手动 API 接入点设置功能，根据测速工具检测结果，选择最快的 API 接入点；</li>
</ul>
<h3 id="discuz-x25">Discuz X2.5<a class="headerlink" href="#discuz-x25" title="Permanent link">&para;</a></h3>
<h4 id="_4">插件下载<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<ul>
<li>最新版插件(v0.4.1) 下载：<a href="http://upyun-assets.b0.upaiyun.com/docs/discuz-plugin/dz_upyun_v0.4.1.zip">Zip 压缩包</a> | <a href="http://upyun-assets.b0.upaiyun.com/docs/discuz-plugin/dz_upyun_v0.4.1.7z">7z 压缩包</a></li>
<li>最新版插件(v0.4.1) 安装使用手册下载：<a href="http://upyun-assets.b0.upaiyun.com/docs/discuz-plugin/readme_v0.4.1.docx">Word 版</a> | <a href="http://upyun-assets.b0.upaiyun.com/docs/discuz-plugin/readme_v0.4.1.pdf">Pdf 版</a></li>
</ul>
<h4 id="_5">版本更新说明<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<p><strong>v0.4.1 更新说明</strong></p>
<ul>
<li>优化对 PHP 5.2.x 的支持，解决 PHP 5.2.x 版本用户 diy 模块和图片更新出错、帖子无法推送的 bug。</li>
<li>PHP 5.3.x 版本用户可不更新此版本插件</li>
</ul>
<p><strong>v0.4 更新说明</strong></p>
<ul>
<li>新增手动 API 接入点设置功能，根据测速工具检测结果，选择最快的 API 接入点；</li>
<li>新增 API 接入点测速小工具；</li>
<li>优化图片类附件下载，实现浏览器下载保存图片附件（之前版本可能会存在浏览器直接打开预览图片的情况）；</li>
<li>优化附件下载后文件名命名，避免下载后附件文件名被修改成随机乱码。</li>
</ul>
<p><strong>v0.3 更新说明</strong></p>
<ul>
<li>将 Discuz 自带的 FTP 上传核心整体替换成 HTTP 上传，提升上传速度、稳定性和兼容性；</li>
<li>解决部分由于虚拟主机权限限制导致无法使用远程附件的问题；</li>
</ul>
<p><strong>v0.2 更新说明</strong></p>
<ul>
<li>优化上传代码，提升上传速度和效率；</li>
<li>修复 discuz 官方远程附件中无法删除远端空间文件的 Bug；</li>
<li>由于 discuz 官方远程附件代码 Bug，无法支持自定义路径，所以插件暂时取消自定义文件路径设置功能</li>
<li>设置表单中添加密钥默认有效时间 900 秒。</li>
</ul>
<p><strong>v0.1 功能介绍</strong></p>
<ul>
<li>代替原有远程附件繁琐的设置步骤，仅需在插件中设置空间，操作员，密码等信息即可使用 UPYUN 服务；</li>
<li>上传的图片和文件分空间存放，并可指定不同域名；</li>
<li>解决官方远程附件下载时仍然调用本地附件地址的问题；</li>
<li>支持本地图片、文件备份；</li>
<li>附件下载支持防盗链。</li>
</ul>
<h3 id="_6">常见问答<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<p><strong>问：</strong>如果文件权限没有修改好就直接安装了插件，该怎么办？
<strong>答：</strong>可以卸载插件，然后修改文件权限，再次安装。或者也可以按照安装说明中附件的文件修改说明，手动修改三个文件的代码</p>
<p><strong>问：</strong>插件正确安装且参数设置正确，但是上传后显示的地址还是本地的？
<strong>答：</strong>尝试进入后台更新论坛数据缓存</p>
<p><strong>问：</strong>插件中设置了参数，还需要在远程附件中设置么？
<strong>答：</strong>不需要，插件会自动修改远程附件的设置，所以只需要在插件中设置相关参数即可，远程附件设置表单无需修改</p></div>
        </div>

        

        <script src="../../js/jquery.min.js"></script>
        <script src="../../js/bootstrap.min.js"></script>
        <script src="../../js/prettify.min.js"></script>
        <script src="../../js/main.js"></script>
        <script src="../../search/main.js"></script>

        <div id="go-top" data-toggle="tooltip" data-placement="bottom" title="回到顶部"><i class="fa fa-arrow-circle-up"></i></div>

        <footer class="footer clearfix">
    <div class="container">
        <ul class="list-unstyled list-inline pull-left">
            <li><a href="/faq/">FAQ</a></li>
            <!-- <li><a href="Blog"></a></li> -->
            <li><a href="https://github.com/upyun">GitHub</a></li>
            <li><a href="https://segmentfault.com/upyun">技术问答</a></li>
            <li><a href="https://www.upyun.com/zh/join_us.html">加入我们</a></li>
        </ul>
        <p class="pull-right">&copy; 2019 又拍云</p>
    </div>
</footer>
        <script type="text/javascript">(function(){document.write(unescape('%3Cdiv id="bdcs"%3E%3C/div%3E'));var bdcs = document.createElement('script');bdcs.type = 'text/javascript';bdcs.async = true;bdcs.src = 'http://znsv.baidu.com/customer_search/api/js?sid=6062249992052412388' + '&plate_url=' + encodeURIComponent(window.location.href) + '&t=' + Math.ceil(new Date()/3600000);var s = document.getElementsByTagName('script')[0];s.parentNode.insertBefore(bdcs, s);})();
        </script>
    </body>
</html>