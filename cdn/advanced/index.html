
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://kougazhang.github.io/cdn-docs/cdn/advanced/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-9.3.1">
    
    
      
        <title>Advanced - CDN Documents v0.0.1</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.046329b4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#_1" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="CDN Documents v0.0.1" class="md-header__button md-logo" aria-label="CDN Documents v0.0.1" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            CDN Documents v0.0.1
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Advanced
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/kougazhang/cdn-docs/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="CDN Documents v0.0.1" class="md-nav__button md-logo" aria-label="CDN Documents v0.0.1" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    CDN Documents v0.0.1
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/kougazhang/cdn-docs/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    文档首页
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
        
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    CDN
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            CDN
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    内容总览
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../product/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    产品介绍
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    快速入门
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../buy/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    购买指南
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../service/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    服务管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../config/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    功能配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../edgerules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    边缘规则
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../analysis/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    统计分析
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../refresh/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    刷新预热
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../log/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    日志管理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../ssl/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    证书服务
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    辅助工具
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../faq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    常见问题
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    直播
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            直播
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../live/Introduction/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    产品简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../live/guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    快速入门
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../live/primary/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    基础配置
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../live/advanced/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    增值服务
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../live/mobile-sdk/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    移动端 sdk
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    点播&短视频
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            点播&短视频
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../video/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    短视频简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../video/short_video_demo/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    短视频 DEMO
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    云存储
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            云存储
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    产品简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../api/quick_start/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    快速入门
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../api/developer_guide/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    开发者指南
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../api/authorization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    认证鉴权
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../api/rest_api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    REST API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../api/form_api/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    FORM API
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../api/developer_tools/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    开发者工具
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../api/sdk/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SDK 使用文档
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../api/fusion_storage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    融合云存储
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../api/multipart_upload/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    分块上传（已弃用）
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../api/errno/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    API 错误码表
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../api/purge/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    缓存刷新
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../api/small_program/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    微信小程序
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../mobile-stats/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    移动流量
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../sms/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    短信服务
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    云处理
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            云处理
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    产品简介
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/authorization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    认证鉴权
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/image/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    图片处理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/av/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    异步音视频处理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/sync_video/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    同步视频处理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/sync_audio/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    同步音频处理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/unzip/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    压缩解压缩
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/spider/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    文件拉取
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/uconvert/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    文档转换
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/async_image/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    异步图片拼接
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../cloud/av_pretreatment/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    音视频处理（已弃用）
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    人工智能
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            人工智能
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../ai/audit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    内容识别(有存储)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../ai/audit_nostorage/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    内容识别(无存储)
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../ai/api_console/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    内容处理
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../ai/authorization/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    认证鉴权
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../ai/face_detect/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    人脸识别
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_8" >
        
          <label class="md-nav__link" for="__nav_8" id="__nav_8_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    SDK&工具
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_8">
            <span class="md-nav__icon md-icon"></span>
            SDK&工具
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../download/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    SDK&工具
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
    
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_9" >
        
          <label class="md-nav__link" for="__nav_9" id="__nav_9_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    常见问题
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_9">
            <span class="md-nav__icon md-icon"></span>
            常见问题
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
    <li class="md-nav__item">
      <a href="../../faq/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    常见问题
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    访问控制
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    安全防护
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#https" class="md-nav__link">
    HTTPS 配置
  </a>
  
    <nav class="md-nav" aria-label="HTTPS 配置">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    配置引导
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    自有证书上传
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ssl" class="md-nav__link">
    SSL 证书管理
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#http2" class="md-nav__link">
    HTTP/2
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    注意事项
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    性能优化
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    分段缓存
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    视频拖拉
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    镜像存储
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    跨域配置
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    文件另存为
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ip" class="md-nav__link">
    传递最终用户 IP
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    自定义提示图
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rewrite" class="md-nav__link">
    自定义 Rewrite
  </a>
  
    <nav class="md-nav" aria-label="自定义 Rewrite">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    功能简介
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    应用场景
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    规则说明
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    语法规则
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_17" class="md-nav__link">
    配置引导
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_18" class="md-nav__link">
    经典案例
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


  <h1>Advanced</h1>

<h2 id="_1">访问控制<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p><strong>IP 禁用</strong></p>
<p>假如需要禁用某个 IP 或者某个 IP 段，则需要进行该功能配置。特别地，IP 防盗链目前暂时只支持黑名单逻辑。</p>
<p>配置引导</p>
<p>登陆 <a href="https://console.upyun.com/login/">又拍云管理控制台</a>，依次进入：服务 &gt; 功能配置 &gt; 防盗链 &gt; IP 禁用，点击「管理」按钮即可开始配置。如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-access-ip.png" height="490" width="800" /></p>
<p>注意事项：</p>
<p>1.支持 <code>*</code> 通配符，如 <code>10.11.12.*</code> 将禁止 <code>10.11.12.0~10.11.12.255</code> 的 IP 访问</p>
<p>2.禁用 IP 上限 100 条，被禁止的 IP 访问资源时，将提示 403</p>
<p><strong>地区访问限制</strong></p>
<p>地区访问限制是指根据加速网站的需求，允许或禁止特定区域的终端用户对网站资源的访问。即网站指定地区，允许该地区终端用户访问，而限制其他地区用户访问，或者相反。</p>
<p>配置引导</p>
<p>登陆 <a href="https://console.upyun.com/login/">又拍云管理控制台</a>，依次进入：服务 &gt; 功能配置 &gt; 防盗链 &gt; 地区访问限制，点击「管理」按钮即可开始配置。如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-access-region-limit.png" height="490" width="800" /></p>
<p>详细配置请参见 <a href="https://blog.upyun.com/?p=886">地区访问限制用户指南</a>。</p>
<p><strong>Referer 防盗链</strong></p>
<p>当请求发送到 CDN 服务器后，CDN 服务器检查 HTTP 请求头中的 Referer 字段的信息，禁止或者允许符合特定规则的 Referer 的请求。</p>
<p>配置引导</p>
<p>登陆 <a href="https://console.upyun.com/login/">又拍云管理控制台</a>，依次进入：服务 &gt; 功能配置 &gt; 防盗链 &gt; 域名防盗链，点击「管理」按钮即可开始配置。如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-acces-referer.png" height="490" width="800" /></p>
<p>注意事项：</p>
<p>1.白名单：仅允许名单中的域名网站访问文件，其他域名网站都不允许访问</p>
<p>2.黑名单：仅禁止名单中的域名网站访问文件，其他域名网站都允许访问</p>
<p>3.支持 <code>*</code> 通配符，比如白名单的 <code>*upyun.com</code> 将允许 <code>www.upyun.com</code>、<code>abcupyun.com</code> 等网站访问</p>
<p>4.特别地，默认 <code>允许 Referer 为空</code> 这种情况会绕过防盗链的逻辑，若这里启用 <code>禁止 Referer 为空</code>，那么这类请求就直接被禁止访问了</p>
<p><strong>User-Agent 防盗链</strong></p>
<p>只允许特定的浏览器或者带有特殊 <code>User-Agent</code> 标识的专属的客户端进行访问。目前暂时只支持白名单逻辑。</p>
<p>配置引导</p>
<p>登陆 <a href="https://console.upyun.com/login/">又拍云管理控制台</a>，依次进入：服务 &gt; 功能配置 &gt; 防盗链 &gt; 客户端防盗链，点击「管理」按钮即可开始配置。如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-access-user-agent.png" height="490" width="800" /></p>
<p>注意事项：</p>
<p>1.添加数量上限 50 条</p>
<p>2.<code>User-Agent</code> 不区分大小写，且支持 <code>*</code> 通配符</p>
<p>3.<code>User-Agent</code> 防盗链的优先级高于 Referer 防盗链</p>
<p><strong>Token 防盗链</strong></p>
<p>可设置签名过期时间来控制文件的访问时限。Token 防盗链的目的是使得每个请求的 URL 都具有一定的“时效性”，因此 URL 本身需要携带过期时间相关的信息，同时还需要确保这个过期时间，不能被恶意修改，因此采用 md5 算法，将密文（通常是一个普通字符串）、过期时间、文件路径（过期时间和文件路径通常是有对应关系的，因此也参与 md5 的计算）等信息所计算的 md5 值也加入到 URL 中，CDN 节点在验证请求时，除了验证过期时间，同时还会验证该 md5 值是否匹配，对于不匹配的 md5，说明 URL 被篡改，即使请求未过期也需要禁止服务。</p>
<p>实现原理</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-access-token.png" height="490" width="800" /></p>
<p>配置引导</p>
<p>登陆 <a href="https://console.upyun.com/login/">又拍云管理控制台</a>，依次进入：服务 &gt; 功能配置 &gt; 防盗链 &gt; Token 防盗链，点击「管理」按钮即可开始配置。如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-access-token-miyao.png" height="490" width="800" /></p>
<blockquote>
<p>签名方式</p>
</blockquote>
<p>签名：</p>
<pre><code>_upt = MD5(token 密钥 &amp; etime &amp; URI){中间 8 位} + etime
</code></pre>
<p>参数：</p>
<ul>
<li>token 密钥：用户所填的密钥</li>
<li>etime：过期时间，必须是 UNIX TIME 格式，如： 1378092990</li>
<li>URI：请求地址（不包含?及后面的 Query String），如： /dir/pic.jpg</li>
</ul>
<blockquote>
<p>示例</p>
</blockquote>
<pre><code>设置图片链接 http://&lt;bucket&gt;/dir/pic.jpg  10 分钟有效
当前 Unix 时间 = 1370000000
etime = 1370000000 + 600 = 1370000600
URI = '/dir/pic.jpg'
sign = MD5(token 密钥&amp;etime&amp;URI) = xxxxxxxxxxxxabcdefghyyyyyyyyyyyy
_upt = MD5(token 密钥&amp;etime&amp;URI){中间 8 位} + etime = abcdefgh1370000600

该签名拼接在 URL 地址或用户 Cookie 中，均可起到防盗链作用:
URL: http://&lt;bucket&gt;/dir/pic.jpg?_upt=abcdefgh1370000600
Cookie: _upt=abcdefgh1370000600;
</code></pre>
<blockquote>
<p>代码实例 (PHP)</p>
</blockquote>
<pre><code>&lt;?php
$etime = time() + 600; // 授权十分钟后过期
$key = 'token 密钥';   // token 防盗链密钥
$path = '/dir/pic.jpg'; // 图片相对路径
$sign = substr(md5($key.'&amp;'.$etime.'&amp;'.$path), 12,8).$etime;
?&gt;
</code></pre>
<p><strong>回源鉴权</strong></p>
<p>回源鉴权是一种高级的防盗链方式，适用于对防盗链有很高实时性要求的场景。大概原理是 CDN 边缘节点每次接受到请求之后，都需要回客户源站进行验证，验证通过之后才认为是合法请求，这样 CDN 可以继续提供服务。</p>
<p>配置引导</p>
<p>登陆 <a href="https://console.upyun.com/login/">又拍云管理控制台</a>，依次进入：服务 &gt; 功能配置 &gt; 防盗链 &gt; 回源鉴权，点击「管理」按钮即可开始配置。如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-access-back-to-source-auth.png" height="490" width="800" /></p>
<p>详细配置请参见 <a href="https://blog.upyun.com/?p=877">回源鉴权用户指南</a>。</p>
<p><strong>外链功能</strong></p>
<p>通过管理后台，可以一键禁止整个服务域名下所有资源的访问，特别地，此时会响应 405 状态码给客户端。</p>
<p>配置引导</p>
<p>登陆 <a href="https://console.upyun.com/login/">又拍云管理控制台</a>，依次进入：服务 &gt; 功能配置 &gt; 基础配置 &gt; 外链功能，关闭外链功能。如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-access-wailian.png" height="490" width="800" /></p>
<p>注意事项：</p>
<p>1.服务创建完毕之后，外链功能默认开启</p>
<p>2.关闭外链功能，会导致资源无法访问，请谨慎操作</p>
<hr />
<h2 id="_2">安全防护<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p><strong>WAF 防护</strong></p>
<p>WAF 防护主要防护的是来自对网站源站的动态数据攻击，可防护的攻击类型包括 SQL 注入、XSS 攻击、CSRF 攻击、恶意爬虫、扫描器、远程文件包含等攻击。</p>
<p>配置引导</p>
<p>登陆 <a href="https://console.upyun.com/login/">又拍云管理控制台</a>，依次进入：服务 &gt; 功能配置 &gt; 云安全 &gt; WAF 防护，开启 WAF 保护即可。如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-security-waf.png" height="490" width="800" /></p>
<p>注意事项：适用于动态资源加速，全静态资源加速建议不启用该功能</p>
<p><strong>CC 防护</strong></p>
<p>CC 防护主要是针对网络安全领域中的 CC 攻击而进行的一种应用层攻击防护，该功能通过自定义匹配规则对目标资源进行监控，当请求频率达到触发频率时对疑似攻击请求进行校验，校验通过则允许访问；校验不通过，则直接禁止访问。</p>
<p>配置引导</p>
<p>登陆 <a href="https://console.upyun.com/login/">又拍云管理控制台</a>，依次进入：服务 &gt; 功能配置 &gt; 云安全 &gt; CC 防护，点击「管理」按钮即可开始配置。如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-security-cc.png" height="490" width="800" /></p>
<p>具体配置可以走如下四个步骤：</p>
<ul>
<li>第一步：添加防护策略，设置 URI 匹配规则，例如：/image/*.jpg</li>
<li>第二步：填写访问频率阈值，例如：500次/分钟，在智能防护模式下才有效</li>
<li>第三步：设置 IP 白名单，如果要绕过 CC 防护策略，此处可进行设置</li>
<li>第四步：选择 CC 防护模式，包括强制防护、智能防护、暂停防护，当正在遭受攻击时，建议选择强制防护模式</li>
</ul>
<p>注意事项：</p>
<p>1.CC 防护分为强制防护和智能防护两种模式，在智能防护模式下，则会匹配 URI 规则，请求一旦达到访问频率阈值，则会触发 JavaScript 校验，校验通过则可正常访问，校验不通过则直接拒绝。在强制防护模式下，则会忽略访问频率阈值，直接触发 JavaScript 校验，以此类推</p>
<p>2.在智能防护模式下，访问阈值设置得过低，可能不会触发 JavaScript 校验，建议阈值设置高一些</p>
<p><strong>HTTP 请求大小限制</strong></p>
<p>可限制单次请求体的内容大小，能有效保证请求的安全性，默认是 512M 。</p>
<p>配置引导</p>
<p>登陆 <a href="https://console.upyun.com/login/">又拍云管理控制台</a>，依次进入：服务 &gt; 功能配置 &gt; 云安全 &gt; HTTP 请求大小限制，点击「管理」按钮即可开始配置。如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-security-request-limit.png" height="490" width="800" /></p>
<p><strong>IP 访问限制</strong></p>
<p>可根据单个 IP 的访问频率来进行防御，在正常的情况下，用户访问网站是有一定频率的，可通过匹配自定义的限制规则对单个 IP 进行监控，将超过设定阈值的 IP 的访问进行拦截或者延迟响应，从而达到安全防护效果。</p>
<p>配置引导</p>
<p>登陆 <a href="https://console.upyun.com/login/">又拍云管理控制台</a>，依次进入：服务 &gt; 功能配置 &gt; 云安全 &gt; IP 访问限制，点击「管理」按钮即可开始配置。如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-ip-limit.png" height="490" width="800" /></p>
<p>配置步骤如下：</p>
<p>第一步：填写访问的资源路径规则，支持 <code>＊</code> 通配符，如：<code>/a/*.mp4</code>、<code>/b/*.flv</code></p>
<p>第二步：选择限制方式：<code>直接禁止</code>或<code>延迟响应</code></p>
<p>第三步：设置访问频率及相应的时间限制</p>
<p>注意事项：</p>
<p>1.直接禁止、延时响应都是以 60s 为一个计数周期，即上一个 60s 的计数不会累计叠加到下一个 60s 内</p>
<p>2.禁止访问时间的设置需大于等于 60s，延迟响应时间的设置需小于等于 30s</p>
<p>3.请勿将访问频率值设置过低，以免影响正常用户的访问请求</p>
<p>详细配置请参见 <a href="https://blog.upyun.com/?p=896">IP 访问限制用户指南</a>。</p>
<hr />
<h2 id="https">HTTPS 配置<a class="headerlink" href="#https" title="Permanent link">&para;</a></h2>
<p>又拍云 HTTPS 加速服务建立在自主研发的内容分发网络基础之上，全面支持了 HTTPS 协议加速。通过会话重用及会话保持、在线证书状态检查、协议优化、SSL 协议握手优化、HTTP/2 等技术手段，全面提升了 HTTPS 协议加速性能。</p>
<h3 id="_3">配置引导<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<p>第一步：依次进入 服务 &gt; 功能配置 &gt; HTTPS, 点击 <code>管理</code> 即可开始配置。如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-https1.png" height="490" width="800" /></p>
<p>第二步：可针对单个域名选择相应的证书，然后保存。如果无证书可选，可前往<a href="https://console.upyun.com/toolbox/ssl/"> SSL 证书服务</a>平台添加域名的自有证书；用户也可直接在<a href="https://console.upyun.com/toolbox/createCertificate/"> SSL 证书申购</a>平台申购 Symantec、GeoTrust、TrustAsia、Let’s Encrypt 的各类 SSL 证书，其中 TrustAsia、Let’s Encrypt 的 DV SSL 单域名证书可免费申请。</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-https2.png" height="490" width="800" /></p>
<p>第三步：可选择是否开启 HTTPS 访问和强制 HTTPS 功能。在开启 HTTPS 访问后，可通过点击 <code>修改</code> 切换域名所对应的证书，点击 <code>详情</code> 可查看相应证书的详细信息；</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-https3.png" height="490" width="800" /></p>
<p>“ HTTPS 访问”：开启该功能后，客户端才能使用 HTTPS 协议进行访问，默认关闭。</p>
<p>“强制 HTTPS ”：勾选此功能后，又拍云边缘节点收到用户的 HTTP 请求后会将其强制跳转到 HTTPS 进行访问。默认：兼容用户的 HTTP 和 HTTPS 请求。</p>
<p>备注：其中 <code>HTTPS 配置</code> 也可以在 <code>SSL 证书管理</code>里面配置，参见下文<code>SSL 证书管理</code>部分。</p>
<h3 id="_4">自有证书上传<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h3>
<p>如果域名当前已有证书，又拍云提供了自有证书的上传方式，无需人工协助，安全便捷。</p>
<p>第一步：进入 SSL 证书服务，工具箱 -&gt; SSL 证书服务 -&gt; 证书管理 -&gt; 添加自有证书 </p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/ssl/upyun-cdn-ssl8.png" height="490" width="800" /></p>
<p>第二步：粘贴证书内容:</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/ssl/upyun-cdn-ssl9.png" height="490" width="800" /></p>
<p>点击 <code>保存</code> 之后，可查看 SSL 证书信息如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/ssl/upyun-cdn-ssl10.png" height="490" width="800" /></p>
<h3 id="ssl">SSL 证书管理<a class="headerlink" href="#ssl" title="Permanent link">&para;</a></h3>
<p>在<a href="https://console.upyun.com/toolbox/ssl/">证书管理</a>列表中，可根据需求选择申购成功并已部署于 CDN 平台的证书或已上传的自有证书，点击 <code>HTTPS 配置</code>进行操作 ，如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/ssl/upyun-cdn-ssl11.png" height="490" width="800" /></p>
<p>“HTTPS 访问”：开启该功能后，客户端使用 HTTPS 协议访问时才能成功，默认关闭。</p>
<p>“强制 HTTPS”：勾选此功能后，又拍云边缘节点收到用户的 HTTP 请求后会将其强制跳转到 HTTPS 进行访问。默认：兼容用户的 HTTP 和 HTTPS 请求。</p>
<h3 id="http2">HTTP/2<a class="headerlink" href="#http2" title="Permanent link">&para;</a></h3>
<p>HTTP/2 即超文本传输协议 2.0，是下一代 HTTP 协议。它由国际互联网工程任务组 （IETF）的 Hypertext Transfer Protocol Bis (httpbis) 工作小组进行开发，以 SPDY 为原型，经过两年多的讨论和完善最终确定。</p>
<p>HTTP/2 优势如下：</p>
<p>1）HTTP/2 采用二进制格式传输数据，其在协议的解析和优化扩展上带来更多的优势和可能。</p>
<p>2）HTTP/2 对消息头采用 HPACK 进行压缩传输，能够节省消息头占用的网络的流量。</p>
<p>3）多路复用，简单说就是所有的请求可以通过一个 TCP 连接并发完成。</p>
<p>4）Server Push：服务端能够更快的把资源推送给客户端。</p>
<p>又拍云 CDN 当前已全平台支持 HTTP/2，并已默认开启。又因 HTTP/2 是在 HTTPS 协议的基础上实现的，所以只要使用又拍云 HTTPS 加速服务的域名，都可免费享受 HTTP/2 服务，无需做任何特殊配置，如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-https4.png" height="490" width="800" /></p>
<h3 id="_5">注意事项<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h3>
<p>又拍云 HTTPS 加速服务是基于 SNI 技术实现的，因此某些不支持 SNI 的浏览器或客户端访问可能出现问题。支持 SNI 的客户端列表如下：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-https5.png" height="490" width="800" /></p>
<p>声明：运行在 Windows XP 上的所有版本的 Internet Explorer 都不支持 SNI ，详细请参考<a href="http://serverfault.com/questions/109800/multiple-ssl-domains-on-the-same-ip-address-and-same-port">这里</a>。</p>
<hr />
<h2 id="_6">性能优化<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<p><strong>GZIP 压缩</strong></p>
<p>目前又拍云 CDN 开启了 GZIP 压缩的相关特性，具体对应的 NGINX 配置如下：</p>
<pre><code>gzip on;
gzip_min_length 256;
gzip_types &lt;见下面的列表&gt;;
gzip_disable &quot;MSIE [1-6]\.&quot;;
gzip_vary on;
</code></pre>
<p>触发实际的 GZIP 压缩行为需要同时满足如下条件：</p>
<blockquote>
<p><code>Content-Type</code> 满足以下列表其中之一：</p>
</blockquote>
<pre><code>text/plain
text/javascript
text/css
text/xml
text/x-component
application/javascript
application/x-javascript
application/xml
application/json
application/xhtml+xml
application/rss+xml
application/atom+xml
application/x-font-ttf
application/vnd.ms-fontobject
image/svg+xml
image/x-icon
font/opentype

text/html -- default
</code></pre>
<blockquote>
<p><code>Content-Length</code> 大于 256 字节</p>
<p>客户端请求头带了 <code>Accept-Encoding: gzip</code></p>
</blockquote>
<p><strong>代码压缩</strong></p>
<p>开启后，会自动去除 HTML 文件中非必要的字符（空白、注释等），自动压缩文件大小，提升访问速度。特别地，目前仅支持 HTML 代码的优化。</p>
<p>配置引导</p>
<p>登陆 <a href="https://console.upyun.com/login/">又拍云管理控制台</a>，依次进入：服务 &gt; 功能配置 &gt; 高级功能 &gt; 代码压缩，开启开关即可，如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-performance-daimayasuo.png" height="490" width="800" /></p>
<p><strong>参数跟随</strong></p>
<p>参数跟随功能包括三种模式，分别是 <code>参数不跟随</code> 、<code>全程跟随</code> 、<code>回源跟随</code> ，系统默认为 <code>全程跟随</code> 模式。一般情况下，根据业务情况，建议选择 <code>参数不跟随</code> 来提高资源文件缓存命中率。详细介绍如下：</p>
<p>参数不跟随：</p>
<blockquote>
<p>开启后，系统会过滤请求中的查询字符串，并且查询字符串不会传递给源站</p>
</blockquote>
<p>全程跟随：</p>
<blockquote>
<p>开启后，将不再过滤请求中的查询字符串，并将查询字符串传递给源站</p>
</blockquote>
<p>回源跟随：</p>
<blockquote>
<p>开启后，会过滤请求中的查询字符串，在访问回源阶段会将查询字符串传递给源站</p>
</blockquote>
<p>配置引导</p>
<p>登陆 <a href="https://console.upyun.com/login/">又拍云管理控制台</a>，依次进入：服务 &gt; 功能配置 &gt; 基础配置 &gt; 参数跟随，点击管理即可开始配置。如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-performance-param-management.png" height="490" width="800" /></p>
<p>注意：参数跟随功能，可以配合缓存配置功能来使用。</p>
<p><strong>重定向优化</strong></p>
<p>当 CDN 节点回源站时，若源站响应的状态码为 301/302，CDN 节点对重定向之后的目标 URL （也即 301/302 响应头 <code>Location</code> 字段对应的信息）发起请求，将获取后的内容响应给最终用户，并在 CDN 节点进行缓存。这样向最终用户屏蔽了重定向过程，免去了最终用户再次向重定向后的 URL 重新发起请求的连接时间，从而加快了访问速度。</p>
<p>原理介绍</p>
<p>一般情况下，当 CDN 节点回源站请求文件时，若源站返回的是 HTTP 301/302 的响应，CDN 节点会将该响应返回给客户端，客户端根据响应头中的 <code>Location</code> 头信息进行再次请求。配置了重定向优化功能之后，访问流程如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-302redirect-yuanli.png" height="300" width="700" /></p>
<p>1）客户端向 CDN 节点发起请求并传递至源站，例如：<code>http://example.com/123.html</code>；</p>
<p>2）源站给 CDN 节点响应 301/302 状态码，并指明重定向后的 URL 为 <code>http://example.com/456.html</code></p>
<p>3）CDN 节点对重定向之后对目标 URL 发起请求；</p>
<p>4）源站响应内容给最终用户，并将内容在 CDN 节点进行缓存；</p>
<p>配置引导</p>
<p>登陆 <a href="https://console.upyun.com/login/">又拍云管理控制台</a>，依次进入：服务 &gt; 功能配置 &gt; 高级功能 &gt; 重定向优化，滑动开关即可开启该功能。如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-redirect-performance.png" height="490" width="800" /></p>
<p><strong>文件合并</strong></p>
<p><code>又拍云存储</code> 和  <code>自主源站</code> CDN 加速服务均支持 JS，CSS Combo（组合特性），即可以把多个 JS, CSS 请求合并成一个。</p>
<p>如何使用</p>
<blockquote>
<p>特别地，我们以 <code>!!</code> 作为分隔符。</p>
</blockquote>
<pre><code>http://upyun-assets.b0.upaiyun.com/foo/!!a.js,b.js
</code></pre>
<p>一个引用了如上 URL 的 Demo:</p>
<pre><code>http://upyun-assets.b0.upaiyun.com/jscombo.html
</code></pre>
<hr />
<h2 id="_7">分段缓存<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<p>又拍云 CDN 服务可提供分段缓存功能配置，开启该功能可有效降低大文件回源率，提升响应速度，与此同时，可以提高文件在 CDN 节点的缓存命中率。特别地，开启该特性之后，CDN 节点会以 Range 请求回源。</p>
<p><strong>配置引导</strong></p>
<p>登陆 <a href="https://console.upyun.com/login/">又拍云管理控制台</a>，依次进入：服务 &gt; 功能配置 &gt; 高级服务 &gt; 分段缓存，点击「管理」按钮即可开始配置。如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-slice-cache.png" height="490" width="800" /></p>
<p>默认配置：该特性会默认关闭，您可以有选择性的开启该特性。特别地，我们针对分段缓存预置了文件后缀模板，也即可以根据文件后缀或者通配符规则来配置是否开启分段缓存功能。默认预置后缀如下：</p>
<pre><code>视频：AVI、MP4、FLV、MOV、3GP、ASF、WMV、MPG、F4V、M4V、MKV、VOB、M3U8、TS 、RMVB、DAT、RM
音频：MP3、OGG、M4A、WMA、AIF、AU
安装包：APK、ZIP、EXE、RAR、IPA、PXL、DEB、SIS、SISX、JAR、XAP
游戏下载：SO、CUE、CCD、MDS、IMG、7Z
其它：CAB、DHP、GZ、ISO、MPQ、PBCV、PXL、QNP、R00、XY、XY2
</code></pre>
<p><strong>配置效果</strong></p>
<p>假设最终用户发起了资源请求，请求的 URL 为：<code>http://www.example.com/download/game.zip</code>，CDN 节点收到请求后，若命中则响应对应分段文件给最终用户，未命中的分段 CDN 节点则回源发起 Range 请求获取资源文件。</p>
<p>开启分段缓存：</p>
<ul>
<li>若最终用户发起资源请求，CDN 节点上已经命中该分段，则直接响应给最终用户</li>
<li>若 CDN 节点未命中缓存，则 CDN 节点回源使用 Range 请求，分段获取资源文件</li>
</ul>
<p>关闭分段缓存：</p>
<ul>
<li>节点文件缓存过期之后，会向源站获取整个资源文件</li>
</ul>
<p>分段预加载：</p>
<ul>
<li>开启分段缓存功能之后，该特性会默认开启。当最终用户请求第一个分段文件时，我们会提前去下载后面几个分段文件，进而提高文件下载速度</li>
</ul>
<p><strong>注意事项</strong></p>
<p>1、源站需要支持 Range 请求，否则会导致回源失败；严格来说，我们只通过 <code>Accept-Ranges: bytes</code> 这个头来判断源支不支持 Range 请求 ，否则即使开启了分段缓存特性，也不会生效；</p>
<p>2、该功能配置后不会立即生效，需在文件缓存过期或者文件缓存被主动刷新之后方可生效；</p>
<p>3、该功能仅针对静态文件，动态内容开启分段缓存会可能会发生错误，请谨慎使用；</p>
<p>4、该功能开启后，资源在 CDN 节点上会进行分段缓存，如果要立马关闭该特性，可通过手动刷新文件来解决；</p>
<p>5、如果您已经使用又拍云对象存储服务，该特性已经默认开启，无需做任何配置；</p>
<hr />
<h2 id="_8">视频拖拉<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h2>
<p>视频拖拉功能用于视频点播的增强体验，方便最终用户通过拖拉播放器的进度条，观看任意起始位置的视频，而无需从头观看。该功能还可以扩展为跳过片头、续播、预播放等功能。发送拖拉播放进度时，客户端发起的请求类似 <code>http://video.upyun.com/test.mp4?start=100</code> 这样的 URL 请求。</p>
<p>配置引导</p>
<p>登陆 <a href="https://console.upyun.com/login/">又拍云管理控制台</a>，依次进入：服务 &gt; 功能配置 &gt; 高级功能 &gt; 视频拖拉，点击管理即可开始配置。如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-video-drag.png" height="490" width="800" /></p>
<p>详细配置请参见 <a href="https://blog.upyun.com/?p=873">「支持从任意起点观看」视频拖拉用户指南</a></p>
<p>注意事项：</p>
<p>1.为了保证正常拖拉，播放器可以发起约定格式的请求，例如：<code>http://example.com/video/test.mp4?start=xxx&amp;end=xxx</code></p>
<p>2.视频文件需含有关键帧，这是实现拖拉的前提条件，关键帧太少或者没有关键帧，视频文件需要重新编码</p>
<p>3.视频文件 <code>metedata</code> 中缺少关键帧的索引信息，如 FLV 缺少 <code>keyframes</code> 信息，MP4 缺少 <code>seekpoint</code> 信息，或缺失 <code>moov box</code>，都会导致拖拉失败</p>
<p>4.支持根据不同资源路径添加配置，最多仅支持 20 条</p>
<p>5.目前支持文件格式有：MP4 和 FLV，MP4 支持按时间拖拉，FLV 支持按字节拖拉</p>
<hr />
<h2 id="_9">镜像存储<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h2>
<p>使用又拍云 CDN 服务时，源站类型选择的是 <code>自主源</code>  模式（也即客户的网站资源都托管在自己的服务器或者第三方存储平台上）的话，可以开启镜像存储功能，可以将网站数据平滑迁移至又拍云存储平台，并减小网站回源比例。</p>
<p><strong>实现流程</strong></p>
<p>实现机制可以参照如下流程：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/monitor-storage/upyun-cdn-monitor-storage.png" height="300" width="500" /></p>
<ul>
<li>终端用户访问资源；</li>
<li>又拍云 CDN 节点从用户自主源站获取资源；</li>
<li>返回资源给终端，并持久化存储到又拍云存储平台；</li>
<li>终端用户再次访问时，将直接从又拍云获取资源，不再回源获取；</li>
<li>随着终端用户的不断访问，源站的资源逐步自动存储到又拍云存储平台。</li>
</ul>
<p>配置引导</p>
<p>登陆 <a href="https://console.upyun.com/login/">又拍云管理控制台</a>，依次进入：服务 &gt; 功能配置 &gt; 高级功能 &gt; 镜像存储，点击开启即可开始配置。如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-monitor-storage-management.png" height="490" width="800" /></p>
<p>又拍云镜像存储功能包括三种状态，分别是开启、暂停、关闭，详细描述如下：</p>
<p><strong>开启状态</strong></p>
<p>开启之后，当 CDN 节点缓存失效时，会优先回又拍云存储获取资源，如果又拍云存储没有命中资源，则直接回自有源站获取资源并响应给最终用户，与此同时，资源会被扔进镜像存储队列并进行存储，下一个相同的资源请求过来时则会直接由存储命中的资源直接提供服务。</p>
<p><strong>暂停状态</strong></p>
<p>直接关闭镜像存储功能，可能会导致回源压力过大，我们会先进入暂停状态，该状态下不会进行资源迁移动作，访问资源时，仍然先访问又拍云存储，如果存储上没有命中资源，则会访问自主源站。</p>
<p><strong>关闭状态</strong></p>
<p>该功能关闭之后，新的请求过来的话，CDN 节点不会回又拍云存储平台获取资源，则会直接回客户源站获取资源。</p>
<p><strong>注意事项</strong></p>
<p>1.当用户更新了源站资源时，为了保证请求访问到的资源是最新的，此时需要通过 API 或 FTP 的方式对已经存储在又拍云存储上的文件进行删除和替换操作</p>
<p>2.当镜像存储功能处于暂停状态时，您可以通过 API 接口逐步删除又拍云上对应的文件，将回源流量平滑迁移至源站，或调整源站带宽，最后再执行关闭操作</p>
<hr />
<h2 id="_10">跨域配置<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h2>
<p>跨域资源共享 （ Cross-Origin Resource Sharing）是一种网络浏览器的技术规范，他为  Web 服务器定义了一种方式，允许网页从不同的域访问其资源。跨源资源共享标准通过新增一系列 HTTP 头，让服务器能声明那些来源可以通过浏览器访问该服务器上的资源。此时需要在 Response Header 中增加跨域相关配置，这样就可以使得资源的安全访问成为可能。</p>
<p>配置引导</p>
<p>登陆 <a href="https://console.upyun.com/login/">又拍云管理控制台</a>，依次进入：服务 &gt; 功能配置 &gt; 高级功能 &gt; CORS 跨域共享，点击管理即可开始配置。如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-cors-config.png" height="490" width="800" /></p>
<p><strong>Access-Control-Allow-Origin</strong></p>
<p>返回的资源需要有一个 <code>Access-Control-Allow-Origin</code> 头信息，也可以设置通配符＊，允许被所有域使用。语法如下:</p>
<blockquote>
<p>Access-Control-Allow-Origin: <origin> | *</p>
</blockquote>
<p>举个栗子，允许来自 <code>http://www.upyun.com</code> 的请求，你可以这样指定:</p>
<blockquote>
<p>Access-Control-Allow-Origin: http://www.upyun.com</p>
</blockquote>
<p><strong>Access-Control-Allow-Methods</strong></p>
<p>表示允许的跨域请求的方法，在当前请求的域被允许后，还要检查当前请求的方法是否被允许，示例如下：</p>
<blockquote>
<p>Access-Control-Allow-Methods: POST, GET, OPTIONS</p>
</blockquote>
<p><strong>Access-Control-Allow-Headers</strong></p>
<p>也是在响应预检请求的时候使用，用来指明在实际的请求中，可以使用哪些自定义 HTTP 请求头，比如：</p>
<blockquote>
<p>Access-Control-Allow-Headers: X-PINGOTHER，X-UPYUN</p>
</blockquote>
<p>这样在实际的请求里,请求头信息里就可以有这么一条：</p>
<blockquote>
<p>X-PINGOTHER: hello</p>
</blockquote>
<p><strong>Access-Control-Expose-Headers</strong></p>
<p>设置浏览器允许访问的服务器的头信息的白名单，示例如下：</p>
<blockquote>
<p>Access-Control-Expose-Headers: X-My-Custom-Header, X-Another-Custom-Header</p>
</blockquote>
<p>这样，<code>X-My-Custom-Header</code> 和 <code>X-Another-Custom-Header</code> 这两个头信息，都可以被浏览器得到。</p>
<p><strong>Access-Control-Max-Age</strong></p>
<p>这个头告诉我们这次预请求的结果的有效期是多久，单位为秒，设置示例如下：</p>
<blockquote>
<p>Access-Control-Max-Age: 864000</p>
</blockquote>
<p>表明在 86400s（10天）内，对该资源的跨域访问不再发送另外一条预请求。</p>
<p>注意事项：</p>
<p>1）最多支持添加 10 条规则，匹配时从第一条开始逐条匹配，以最早匹配上的规则为准</p>
<p>2）<code>允许的域</code>、<code>Allow Header</code> 、<code>Expose Header</code> 最多允许 20 行</p>
<p>3）<code>允许的域</code> 及 <code>Methods</code> 建议根据需要使用最小的配置来保证安全性，多条规则间不要有覆盖和冲突</p>
<p>4）<code>允许的域</code> 需带上完整的域信息，即指定 https 或者 http，或者 <code>*://foo.com</code> 这样的形式</p>
<p>5）<code>Allow Header</code>、<code>Expose Header</code> 不允许使用通配符，大小写不敏感</p>
<p>6） <code>缓存时间</code> 如果没有特殊情况可以酌情设置得大一点，默认为 86400 秒，最大为 604800 秒</p>
<hr />
<h2 id="_11">文件另存为<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2>
<p>又拍云 CDN 服务支持对响应头 <code>Content-Disposition</code> 字段的特殊设置，也即在请求 URL 中加入 <code>_upd</code> 参数可对 <code>Content-Disposition</code> 进行特殊化配置。通过对该参数的配置就可以强制浏览器触发下载行为，同时该参数的值会作为文件下载后保存到本地的文件名。特别地，当其值为 <code>true</code> 时，保持原文件名不变。</p>
<p>配置引导</p>
<p>示例一：</p>
<pre><code>请求参数中加入 “_upd=true” ，代表添加响应头为： Content-Disposition: attachment
</code></pre>
<pre><code>$ curl http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-architecture.png?_upd=true -I

&gt; HTTP/1.1 200 OK
&gt; Content-Type: image/png
&gt; Content-Length: 57371
&gt; ...
&gt; Accept-Ranges: bytes
&gt; Content-Disposition: attachment;

</code></pre>
<p>示例一：</p>
<pre><code>请求参数中加入 “_upd=abc.png”，代表添加响应头为： Content-Disposition: attachment; filename="abc.png"
</code></pre>
<pre><code>$ curl http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-architecture.png?_upd=abc.png -I

&gt; HTTP/1.1 200 OK
&gt; Content-Type: image/png
&gt; Content-Length: 57371
&gt; ...
&gt; Accept-Ranges: bytes
&gt; Content-Disposition: attachment; filename=&quot;abc.png&quot;

</code></pre>
<p>注意事项</p>
<p>特别地， <code>参数跟随</code> 开启的情况下，此参数无效。</p>
<hr />
<h2 id="ip">传递最终用户 IP<a class="headerlink" href="#ip" title="Permanent link">&para;</a></h2>
<p>又拍云 CDN 回客户源的时候会带上 <code>X-Real-IP</code> 和 <code>X-Forwarded-For</code> 的请求头下去，值为用户实际访问 CDN 的来源 IP 地址。特别地，为了兼容部分服务端程序，我们额外还提供了 <code>Client-IP</code> 请求头的支持，其值和 <code>X-Real-IP</code>、<code>X-Forwarded-For</code> 相同。</p>
<p>如何使用</p>
<p>1、X-Real-IP 传递用户 IP</p>
<p>使用该方式传递最终用户 IP ，需要服务端代码进行一些改造，网站需要根据使用编程语言的不同，修改相应的代码模块，才可以传递最终用户 IP。代码示例如下：</p>
<p>示例一：PHP 代码¶</p>
<pre><code> &lt;?php
        $ip = $_SERVER["HTTP_X_REAL_IP"];
        echo $ip;
 ?&gt;
</code></pre>
<p>示例二： Nginx 配置¶</p>
<pre><code>server
    {
        listen 80;
        add_header X-Real-IP $http_x_real_ip;
    }
</code></pre>
<p>2、X-Forward-For 传递用户 IP</p>
<p>回源请求头会默认传递 <code>X-Forwarded-For</code> 的值，用户网站无需任何改造。</p>
<p>注意事项</p>
<p>1、新增加速服务时我们会默认使用 <code>X-Real-IP</code> 和 <code>X-Forwarded-For</code> 方式，网站只需要按照 “如何使用” 章节中，对原先的用户 IP 获取代码进行替换即可；</p>
<p>2、由于 <code>X-Real-IP</code>  是又拍云 CDN 服务特有的回源请求头 ，故终止 CDN 后，网站需将获取用户 IP 的代码修改为原始代码；</p>
<p>3、在选择使用 <code>X-Forwarded-For</code> 进行最终用户 IP 传递时  ，<code>X-Real-IP</code>、<code>Client-IP</code>也是同时传递的；</p>
<hr />
<h2 id="_12">自定义提示图<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h2>
<p>支持自定义错误状态设置，目前支持 403、404、405 错误码自定义提示图的设置。如未设置，则默认遵循又拍云 CDN 服务默认错误状态提示图。</p>
<p>配置引导</p>
<p>登陆 <a href="https://console.upyun.com/login/">又拍云管理控制台</a>，依次进入：服务 &gt; 功能配置 &gt; 高级服务 &gt; 自定义提示图，在此栏目下进行相应图片的提示。如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-custom-map.png" height="490" width="800" /></p>
<blockquote>
<p>403 提示图</p>
</blockquote>
<p>当用户设置了例如 IP 禁用、Referer 等防盗链配置并且当前的请求与规则不匹配时，即会响应 403 给客户端，表示该次请求被禁止。另外，若该服务设置了自定义 403 提示图，那么此类情况下就会响应一个 302 跳转到相应的图片。</p>
<blockquote>
<p>404 提示图</p>
</blockquote>
<p>当请求的文件不存在时，会响应 404 状态码，可通过自定义提示图来展示。</p>
<blockquote>
<p>405 提示图</p>
</blockquote>
<p>正常使用中的服务，若被人为地设置为禁止外链，此时访问就会响应 405 状态码。同样，405 也支持自定义提示图设置。</p>
<p>注意事项</p>
<p>1、若此处未设置任何自定义提示图，CDN 服务会默认响应一个错误状态码提示图；</p>
<p>2、此处自定义提示图的文件大小限制在 30KB 以内；</p>
<hr />
<h2 id="rewrite">自定义 Rewrite<a class="headerlink" href="#rewrite" title="Permanent link">&para;</a></h2>
<h3 id="_13">功能简介<a class="headerlink" href="#_13" title="Permanent link">&para;</a></h3>
<p>自定义 rewrite 是基于 DSL ( Domain Specific Language ) 理念来设计的，主要面向开发者使用。充分利用又拍云 CDN ( Content Delivery Network )分布式边缘网络的性能及规模，通过又拍云管理控制台可轻松创建 rewrite 规则，规则支持函数、变量、字符串常量，用户可以将这些自由组合，可以实现对 URL 的改写、重定向、自定义 HTTP 头、请求禁止等处理逻辑。</p>
<h3 id="_14">应用场景<a class="headerlink" href="#_14" title="Permanent link">&para;</a></h3>
<ul>
<li>
<p>提高安全性：可以有效的避免一些参数名、ID 等完全暴露在用户面前；</p>
</li>
<li>
<p>URL 美化：去除了那些比如 <code>*.do</code> 之类的后缀名、长长的参数串等，可以自己组织精简更能反映访问模块内容的 URL；</p>
</li>
<li>
<p>提高网站 SEO：通过 URL Rewrite 之后，更有利于搜索引擎的收入，通过对 URL 的一些优化，可以使搜索引擎更好的识别与收录网站的信息；</p>
</li>
<li>
<p>HTTP 头改写：新增、删除 HTTP 请求头，新增、删除 HTTP 响应头等处理逻辑；</p>
</li>
<li>
<p>防盗链设置：可以很灵活、高效的编写防盗链规则和处理逻辑，可以实现高强度的防盗链规则；</p>
</li>
<li>
<p>边缘重定向：可以根据特殊的业务逻辑，触发某个条件之后，可将请求重定向到特定的地址等等；</p>
</li>
</ul>
<h3 id="_15">规则说明<a class="headerlink" href="#_15" title="Permanent link">&para;</a></h3>
<p>为了更好的理解 rewrite 规则，本节围绕 rewrite 规则配置项和规则示例来进行详细说明，先来了解下配置截图，如下截图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-custom-rewrite-config.png" height="380" width="800" /></p>
<p>如上所示，配置一条完整的 rewrite 规则需要完成 <code>Rewrite 规则</code> 、<code>URI 提取正则</code> 、<code>break</code> 、<code>调试模式</code> 、<code>备注</code> 这 5 个选项的配置，其中 <code>Rewrite 规则</code> 为必填项，<code>URI 提取正则</code> 和<code>备注</code> 为可填项，<code>break</code>  和 <code>调试模式</code> 为控制开关，可根据需要来进行开启和关闭。</p>
<p>下面我们来结合配置好的规则示例来说明下每个配置项的作用，如下为一组 rewrite 规则集，包括两条 rewrite 规则：</p>
<pre><code>-- JSON
[
rules[
{
    rule :  $WHEN($EQ($_HOST, 'images.foo.com'))/$1,
    pattern :  ^/images/(.*)$
    break :  true,
    debug :  true,
    description :  URL改写,

},
{
    rule :  /movies/$1,
    pattern :  /download/(.*)$
    break :  true,
    debug :  true,
    description :  目录改写,

},
]
</code></pre>
<p>通过以上规则集的了解，下面我们针对规则集里面的每个部分做相应的介绍和解释：</p>
<p><code>pattern</code> 为对当前请求 URI 进行匹配的 <code>PCRE</code>  正则表达式，匹配后，产生 <code>$1, $2 ...</code>  这样的变量，对应配置项里面的<code>URI 提取正则</code>；</p>
<p><code>rule</code> rewrite 规则主要组成部分，代表最终的处理逻辑，详细请看语法规则部分，对应配置项里面的 <code>rewrite 规则</code>；</p>
<p><code>break</code> 表示如果此次 rewrite 成功后是否要终止剩下的的 rewrite 过程；</p>
<p><code>debug</code> 是一个调试开关，默认开启，对应配置截图里面的 <code>调试模式</code>；</p>
<p><code>description</code> 用来描述该规则的用途； 对应配置项里面的 <code>备注</code> 。</p>
<p><strong>调试模式</strong></p>
<p>由于 rewrite 过程会对当前请求产生副作用，这是非常危险的，例如随意的填写一条 rewrite 规则：</p>
<blockquote>
<p>/foo</p>
</blockquote>
<p>此规则会将所有请求的 URI 改写成 <code>/foo</code>，这样客户端所有请求的响应就变成 404 了， 这是您极不愿意看到的结果。我们允许对 rewrite 规则进行调试，即新增加一条规则时，<code>调试模式</code> 开关会默认打开，这样添加规则后，即使当前请求命中该 rewrite 规则， rewrite 过程也不会生效，只有当包含以下请求头时，rewrite 过程才会生效：</p>
<blockquote>
<p>X-Upyun-Rewrite-Preview: true</p>
</blockquote>
<p>使用命令行工具 curl 即可对规则调试：</p>
<blockquote>
<p>curl -H "X-Upyun-Rewrite-Preview: true" http://your-domain/foo/bar.html -v</p>
</blockquote>
<p>这样经过调试，确定该 rewrite 过程符合预期后，即可将 <code>调试模式</code> 关闭，此时该 rewrite 过程会对所有命中的请求生效。</p>
<p>注意：特别地，调试模式目前仅针对 URI 和 ARGS 修改以及一些函数有效，受 <code>调试模式</code> 开关影响的 rewrite 操作有：</p>
<pre><code> - $LIMIT_RATE_AFTER()
 - $LIMIT_RATE
 - $DEL_REQ_HEADER(E)
 - $REDIRECT(E1,E2)
 - $DEL_ARG(E)
 - $EXIT(E1,E2)
 - $ADD_REQ_HEADER
 - 修改 URI 和 ARGS 的操作
</code></pre>
<h3 id="_16">语法规则<a class="headerlink" href="#_16" title="Permanent link">&para;</a></h3>
<p><strong>函数</strong></p>
<p>函数调用以 <code>$</code> 开头，后跟一组大写字母，字母之间可以包含下划线 <code>_</code>，函数需要的参 数放在<code>()</code>中，以 <code>,</code> 分隔。如果没有特别说明，rewrite 中的函数参数个数不能少于要求的参数个数，否则视为语法错误，然后终止 rewrite 过程，多余的参数会被求值，但不影响调用。函数调用是有上下文的，譬如 <code>$WHEN</code> 这个函数，参数是 <code>bool</code> 类 型，参数中有不成立的条件 <code>false</code> 时，会终止 rewrite 过程。支持的函数有：</p>
<blockquote>
<p>条件选择和判断</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align: left;">函数</th>
<th style="text-align: left;">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>$WHEN(E1, E2, ...)</code></td>
<td style="text-align: left;">所有条件都成立时才进行 <code>rewrite</code>，并返回空字符串</td>
</tr>
<tr>
<td style="text-align: left;"><code>$NOT(E)</code></td>
<td style="text-align: left;"><code>E</code> 不成立时返回 <code>true</code>， 否则返回 <code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>$ALL(E1, E2, ...)</code></td>
<td style="text-align: left;">所有条件都成立时返回 <code>true</code>，否则返回 <code>false</code>，参数个数不限</td>
</tr>
<tr>
<td style="text-align: left;"><code>$ANY(E1, E2, ...)</code></td>
<td style="text-align: left;">其中一个条件成立时返回 <code>true</code>，否则返回 <code>false</code>，参数个数不限</td>
</tr>
<tr>
<td style="text-align: left;"><code>$OR(E1, E2, ...)</code></td>
<td style="text-align: left;">值为第一个为真的表达式</td>
</tr>
<tr>
<td style="text-align: left;"><code>$SELECT(E1, E2, E3)</code></td>
<td style="text-align: left;"><code>E1</code> 为真时值为 <code>E2</code>，否则为 <code>E3</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>$PCALL(E)</code></td>
<td style="text-align: left;">保护模式下解析 <code>E</code>，失败时返回空字符串</td>
</tr>
</tbody>
</table>
<blockquote>
<p>字符匹配和捕获</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align: left;">函数</th>
<th style="text-align: left;">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>$MATCH(E1, E2)</code></td>
<td style="text-align: left;">PCRE 匹配，<code>E2</code> 为要匹配的 pattern，返回 <code>true</code> 或者 <code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>$CAPTURE(E1, E2, E3)</code></td>
<td style="text-align: left;">按 <code>E2</code> pattern 对 <code>E1</code> 进行捕获，<code>E3</code> 表示是否忽略大小写，捕获后生成 <code>$n.m</code> 形式的变量，<code>n</code> 为当前 <code>CAPTURE</code> 出现的次序，<code>m</code> 表示匹配分组；<code>E2</code> 为空时，表示对 <code>E1</code> 进行捕获，此时 <code>E1</code> 对应 <code>$n.0</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>请求/响应修改</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align: left;">函数</th>
<th style="text-align: left;">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>$ADD_REQ_HEADER(E1, E2)</code></td>
<td style="text-align: left;">添加请求头 <code>E1</code> 为 <code>E2</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>$DEL_REQ_HEADER(E)</code></td>
<td style="text-align: left;">删除请求头 <code>E</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>$ADD_RSP_HEADER(E1, E2)</code></td>
<td style="text-align: left;">添加响应头 <code>E1</code> 为 <code>E2</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>$DEL_ARG(E)</code></td>
<td style="text-align: left;">删除请求参数项 <code>E</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>$SET_METHOD(E)</code></td>
<td style="text-align: left;">修改当前 HTTP 请求方法为 <code>E</code>，<code>E</code> 可选值有：<code>GET</code>, <code>HEAD</code>, <code>PUT</code>, <code>POST</code>, <code>DELETE</code>, <code>OPTIONS</code>, <code>PATCH</code>; 注 1</td>
</tr>
<tr>
<td style="text-align: left;"><code>$SET_BODY(E)</code></td>
<td style="text-align: left;">修改当前 HTTP 请求体的内容为 <code>E</code>，仅在 <code>PUT</code> 或 <code>POST</code> 请求下有效</td>
</tr>
<tr>
<td style="text-align: left;"><code>$REDIRECT(E1, E2)</code></td>
<td style="text-align: left;">重定向地址到 <code>E1</code>，状态码为 <code>E2(301, 302)</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>$EXIT(E1, E2)</code></td>
<td style="text-align: left;">以状态码 <code>E1</code> 退出，响应体为 <code>E2</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>数值计算</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align: left;">函数</th>
<th style="text-align: left;">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>$ADD(E1, E2)</code></td>
<td style="text-align: left;">数字相加，返回 <code>E1 + E2</code> 结果数值</td>
</tr>
<tr>
<td style="text-align: left;"><code>$MOD(E1, E2)</code></td>
<td style="text-align: left;">数字取余，返回 <code>E1 % E2</code> 结果数值，其中 <code>E2</code> 不能为 <code>0</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>$MSUB(E1, E2)</code></td>
<td style="text-align: left;">数字相减，返回 <code>E1 - E2</code> 结果数值</td>
</tr>
<tr>
<td style="text-align: left;"><code>$MULTIPLY(E1, E2)</code></td>
<td style="text-align: left;">数字相乘，返回 <code>E1 * E2</code> 结果数值</td>
</tr>
<tr>
<td style="text-align: left;"><code>$DIVIDE(E1, E2)</code></td>
<td style="text-align: left;">数字相除，返回 <code>E1 / E2</code> 结果数值，其中 <code>E2</code> 不能为 <code>0</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>$BYTE(E)</code></td>
<td style="text-align: left;">返回字符 <code>E</code> 的 ASCII 编码值</td>
</tr>
<tr>
<td style="text-align: left;"><code>$FLOOR(E)</code></td>
<td style="text-align: left;">返回小于或等于数字 <code>E</code> 的最大整数</td>
</tr>
<tr>
<td style="text-align: left;"><code>$CEIL(E)</code></td>
<td style="text-align: left;">返回大于或等于数字 <code>E</code> 的最小整数</td>
</tr>
<tr>
<td style="text-align: left;"><code>$GT(E1, E2)</code></td>
<td style="text-align: left;">数字比较，是否大于，返回 <code>true</code> 或者 <code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>$GE(E1, E2)</code></td>
<td style="text-align: left;">数字比较，是否大于等于，返回 <code>true</code> 或者 <code>false</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>字符串操作</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align: left;">函数</th>
<th style="text-align: left;">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>$SUB(E1, from, to)</code></td>
<td style="text-align: left;">字符串截取，从 <code>from</code> 到 <code>to</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>$EQ(E1, E2)</code></td>
<td style="text-align: left;">字符串是否相等，返回 <code>true</code> 或者 <code>false</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>$UPPER(E)</code></td>
<td style="text-align: left;">将 <code>E</code> 转换为大写</td>
</tr>
<tr>
<td style="text-align: left;"><code>$LOWER(E)</code></td>
<td style="text-align: left;">将 <code>E</code> 转换为小写</td>
</tr>
<tr>
<td style="text-align: left;"><code>$LEN(E)</code></td>
<td style="text-align: left;">返回字符串 <code>E</code> 的长度</td>
</tr>
</tbody>
</table>
<blockquote>
<p>通用功能类函数</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align: left;">函数</th>
<th style="text-align: left;">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>$ENCODE_BASE64(E)</code></td>
<td style="text-align: left;">将字符串 E 按 base64 编码压缩</td>
</tr>
<tr>
<td style="text-align: left;"><code>$DECODE_BASE64(E)</code></td>
<td style="text-align: left;">将字符串 E 按 base64 编码解压</td>
</tr>
<tr>
<td style="text-align: left;"><code>$MD5(E)</code></td>
<td style="text-align: left;">计算 <code>E</code> 的 md5 值</td>
</tr>
<tr>
<td style="text-align: left;"><code>$RANDI(E1, E2)</code></td>
<td style="text-align: left;">返回大于 <code>E1</code> 并小于 <code>E2</code> 的随机数值</td>
</tr>
<tr>
<td style="text-align: left;"><code>$UNIXT(y, m, d, h, min, sec)</code></td>
<td style="text-align: left;">指定年，月，日，小时，分钟，秒，返回相应的 UNIX TIME</td>
</tr>
<tr>
<td style="text-align: left;"><code>$INT(E1, E2, E3)</code></td>
<td style="text-align: left;">进制转换，将 <code>E2</code> 进制的数字（字符串形式） <code>E1</code> 转换成 <code>E3</code> 进制并返回，<code>E2</code>, <code>E3</code> 可选，<code>E2</code> 默认为 <code>10</code></td>
</tr>
</tbody>
</table>
<blockquote>
<p>限速相关</p>
</blockquote>
<table>
<thead>
<tr>
<th style="text-align: left;">函数</th>
<th style="text-align: left;">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>$LIMIT_RATE_AFTER(E1, E2)</code></td>
<td style="text-align: left;">限速策略设置，发送 <code>E1</code> 大小单位为 <code>E2</code> 字节数据后，进行限速，<code>E2</code> 可选值有：<code>k</code>（KB)，<code>m</code>（MB）</td>
</tr>
<tr>
<td style="text-align: left;"><code>$LIMIT_RATE(E1, E2)</code></td>
<td style="text-align: left;">限速策略设置，按 <code>E1</code> 大小每秒进行限速，单位为 <code>E2</code>，<code>E2</code> 可选值有：<code>k</code>（KB)，<code>m</code>（MB）</td>
</tr>
</tbody>
</table>
<p>注 1：若当前请求带有请求体的情况下，<code>$SET_METHOD(E)</code> 不允许设置为除 <code>PUT</code> 和 <code>POST</code> 以外的方法。</p>
<p>其中 <code>E[n]</code> 代表合法的表达式，也就是说函数可以相互嵌套，例如规则可以为：</p>
<p><code>/$SUB($DECODE_BASE64($_HEADER_foo), $_GET_from, $_GET_to)/</code>；布尔函数包括 <code>WHEN
, ALL, ANY</code> 都是短路的，譬如 <code>$WHEN($ALL(), $EXIT(403))</code> 不会返回 <code>403</code>，因为
<code>$ALL()</code> 的值为 <code>false</code></p>
<p>使用 <code>''</code> 能对变量进行转义，使其不被解释，例如以下规则：</p>
<pre><code>/foo/'$_HOST'
</code></pre>
<p>会被转换为:</p>
<pre><code>/foo/$_HOST
</code></pre>
<p>对于含有请求参数的规则，原先的请求参数会附加到后面，如果不希望这样，可以放置一个
'?' 在规则的最后面，例如这样：</p>
<pre><code>/foo?bar=$1?
</code></pre>
<p>特别地，如果重写后的 URL 没有参数，那么此时需要在最后加两个 <code>?</code>，例如这样：</p>
<pre><code>/foo??
</code></pre>
<p><strong>变量</strong></p>
<p>变量以 <code>$_</code> 开头，这些变量都是对此次请求上下文中一些参数的映射，譬如 <code>$_HOST</code> 对应此次请求头中的 <code>Host</code> 字段，<code>$_GET_foo</code> 对应此次请求 URL 参数 foo 的值，等等。若将变量内插到重写后的 URL 中，譬如 rewrite <code>/$_GET_foo/bar</code>，如果请求参数中没有 <code>foo</code>则视为此次 rewrite 失败；若将变量放在函数中，则由该函数确定返回的值，例如 <code>$NOT($_GET_foo)</code>，如果参数中包含 <code>foo</code>，则返回 <code>false</code>，否则返回<code>true</code>。目前支持的变量有：</p>
<table>
<thead>
<tr>
<th style="text-align: left;">变量</th>
<th style="text-align: left;">含义</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: left;"><code>$_IP</code></td>
<td style="text-align: left;">客户端 IP</td>
</tr>
<tr>
<td style="text-align: left;"><code>$_HOST</code></td>
<td style="text-align: left;">请求头中的 Host 字段</td>
</tr>
<tr>
<td style="text-align: left;"><code>$_HOST_n</code></td>
<td style="text-align: left;"><code>$_HOST_n</code> 指 Host 中的第 n 个子域，例如对于 foo.bar.baz.com：<code>$_HOST_1 = foo，$_HOST_2 = bar，$_HOST_3 = baz</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>$_GET_name</code></td>
<td style="text-align: left;">使用 Query String 中的变量（无需 urldecode）</td>
</tr>
<tr>
<td style="text-align: left;"><code>$_POST_name</code></td>
<td style="text-align: left;">使用 POST 表单中的变量（只支持 www form ）</td>
</tr>
<tr>
<td style="text-align: left;"><code>$_HEADER_name</code></td>
<td style="text-align: left;">使用 Header 中的值，注意 name 全为小写</td>
</tr>
<tr>
<td style="text-align: left;"><code>$_COOKIE_name</code></td>
<td style="text-align: left;">使用 Cookie 中的字段值</td>
</tr>
<tr>
<td style="text-align: left;"><code>$_RANDOM</code></td>
<td style="text-align: left;">随机字符串，字符集为 <code>[a-zA-Z0-9]</code>，默认 8 位</td>
</tr>
<tr>
<td style="text-align: left;"><code>$_RANDOM_n</code></td>
<td style="text-align: left;"><code>n</code> 位随机字符串，其中 <code>1 &lt;= n &lt;= 32</code></td>
</tr>
<tr>
<td style="text-align: left;"><code>$_URI</code></td>
<td style="text-align: left;">请求的 URI，不包含参数</td>
</tr>
<tr>
<td style="text-align: left;"><code>$_QUERY</code></td>
<td style="text-align: left;">Query String，不带前缀 '?'</td>
</tr>
<tr>
<td style="text-align: left;"><code>$_METHOD</code></td>
<td style="text-align: left;">GET/POST/PUT/POST/DELETE/OPTIONS/PATCH</td>
</tr>
<tr>
<td style="text-align: left;"><code>$_SCHEME</code></td>
<td style="text-align: left;">HTTP/HTTPS</td>
</tr>
<tr>
<td style="text-align: left;"><code>$_TIME</code></td>
<td style="text-align: left;">获取当前服务器时间，格式为 UNIX TIME</td>
</tr>
<tr>
<td style="text-align: left;"><code>$_BODY</code></td>
<td style="text-align: left;">获取当前请求的 BODY（请求体）内容，大小限制为 16KB</td>
</tr>
</tbody>
</table>
<p><strong>字符串常量</strong></p>
<p>字符串常量有两种形式，第一种就是普通的字符串例如<code>/foo/bar</code>，但是如果字符串中包含了一些特殊字符，例如空白字符将被省略，例如 <code>$(),'</code> 这些字符有特殊的用途，不能被直接使用，要使用这些特殊的字符，要加 <code>\</code> 前缀对其转义，例如 <code>/foo/bar\,</code>；第二种是加单引号的字符串 <code>''</code>，单引号中的字符只有 <code>\</code> 是特殊转义字符前缀，其他的都视为普通字符，例如这样一条 rewrite 规则 <code>/foo/'$\\,\''</code>，rewrite 过后对应 <code>/foo/$\,'</code>。</p>
<p><strong>break</strong></p>
<p>除了能勾选 <code>break 选项</code> 指定是否 <code>break</code>，也可以直接在 rewrite 规则最后加上 <code>$$</code> 表示 <code>break</code>。</p>
<h3 id="_17">配置引导<a class="headerlink" href="#_17" title="Permanent link">&para;</a></h3>
<p>登陆 <a href="https://console.upyun.com/login/">管理控制台</a>，依次进入：服务 &gt; 功能配置 &gt; 高级功能 &gt; 自定义 Rewrite，点击管理即可开始配置。如下图所示：</p>
<p><img src="http://upyun-assets.b0.upaiyun.com/docs/cdn/upyun-cdn-custom-rewrite.png" height="490" width="800" /></p>
<h3 id="_18">经典案例<a class="headerlink" href="#_18" title="Permanent link">&para;</a></h3>
<p><strong>1、自定义防盗链</strong></p>
<p>需求描述：将请求 URL 按照一定的算法规则实现 token 防盗链，使用自定义 rewrite 来实现，会更加灵活和高效。token 防盗链详解请参见：https://blog.upyun.com/?p=1177</p>
<p>请求 URL 示例：</p>
<pre><code>/test.ts?key=68ddbe535557d6630a19cebde0cb9252&amp;t=1481106349
</code></pre>
<p>以上请求 URL 是按照如下算法生成的，参见如下算法说明：</p>
<pre><code>&lt;?php
$etime = time() + 600; // 授权 10 分钟后过期 
$key = 'abc'; // token 防盗链密钥
$path = '/test.ts'; // 文件相对路径
$url = $path.'?key='.md5($key.$etime.$path).'&amp;t='.$etime;
echo $url; 
?&gt;
</code></pre>
<p>CDN 节点需要进行两层判断，一层就是对时间戳进行比较，另外一层就是按照约定的规则生成验证信息并进行比较，看是否一致。按照要求，可编写如下规则集来实现以上要求：</p>
<pre><code>rules:
{
  &quot;rule&quot;: &quot;$WHEN($MATCH($_URI, '.ts$'),$OR($NOT($_GET_t),$NOT($_GET_key)))$EXIT(403)&quot;,
  &quot;pattern&quot;: &quot;&quot;
}, 
{
   &quot;rule&quot;: &quot;$WHEN($MATCH($_URI, '.ts$'),$GT($_TIME, $_GET_t))$EXIT(401)&quot;,
   &quot;pattern&quot;: &quot;&quot;
}, 
{
  &quot;rule&quot;: &quot;$WHEN(($MATCH($_URI, '.ts$'),$NOT($EQ($MD5('abc'$_GET_t$_URI),$LOWER($_GET_key))))$EXIT(403)&quot;,
  &quot;pattern&quot;: &quot;&quot;
}
</code></pre>
<p>规则释义：</p>
<p>第一条：当文件后缀为 ts 时，判断请求 URL 里面是否存在 t 和 key 参数，如果其中一个不存在，则返回 403；</p>
<p>第二条：当文件后缀为 ts 时，判断当前 CDN 节点 UNIX 时间是否大于请求参数里面的时间戳（也即参数 t 的值），否则返回 401；</p>
<p>第三条：当文件后缀为 ts 时，CDN 节点按照约定的算法规则生成验证信息（也即 MD5 值），判断生成的 MD5 值和请求参数 key 的值是否一致，不一致则返回 403；</p>
<p><strong>2、边缘重定向</strong></p>
<p>示例一：匹配 <code>cookie</code> 进行跳转</p>
<pre><code>&quot;rule&quot;: &quot;$WHEN($NOT($EQ($_URI, /live.html)), $NOT($_COOKIE_token))$REDIRECT(http://test.example.com/no_token.html)&quot;,
&quot;pattern&quot;: &quot;&quot;
</code></pre>
<p>规则释义：首先匹配请求 <code>URI</code> 是否为 <code>/live.html</code>,当 <code>cookie</code> 中 <code>token</code> 值为空时，则跳转到指定到地址 <code>http://test.example.com/no_token.html</code>。</p>
<p><strong>3、URL 改写</strong></p>
<p>示例一：目录及参数改写</p>
<p>将请求 URL 转换为带参数的动态 URL，例如请求的 URL 为：</p>
<pre><code>http://example.com/pay/25/8/...
</code></pre>
<p>需要 CDN 边缘节点转换为如下请求：</p>
<pre><code>http://example.com/pay.php?payid=25&amp;categoryid=8...
</code></pre>
<p>这个时候，<code>pattern</code> 部分需要提取目录数字，需要生成 <code>$1</code> 和 <code>$2</code> 这样的变量，如下规则所示：</p>
<pre><code>&quot;rule&quot;: &quot;/product.php?productid=$1&amp;categoryid=$2&quot;,
&quot;pattern&quot;: &quot;^product/([0-9]+)/([0-9]+)/(.*?).html$&quot;
</code></pre>
<p>规则释义：当解析的 url 符合规则 <code>^product/([0-9]+)/([0-9]+)/(.*?).html$</code>，那么将请求导向到 <code>/product.php?productid=$1&amp;categoryid=$2</code>。</p>
<pre><code>也即将 http://example.com/pay/25/8/... 转换为 http://example.com/pay.php?payid=25&amp;categoryid=8...
</code></pre>
<p>示例二：文件名改写</p>
<pre><code>pattern: /(.*)/playlist\.m3u8$
rule: /$1'.m3u8'
</code></pre>
<p>规则释义：当访问地址为 <code>http://domain/app/stream/playlist.m3u8</code> 时，将访问地址改写为 <code>http://domain/app/stream.m3u8</code>。</p>
<p>应用场景：在直播应用场景中，因为客户端机制无法或者不方便升级的情况，可以通过 URL 改写，将 <code>/stream/playlist.m3u8</code> 改为 <code>/stream.m3u8</code>，其中 <code>app</code> 代表发布点，<code>stream</code> 代表流名。</p>
<p><strong>4、请求/响应头修改</strong></p>
<p>示例一：添加、删除请求头</p>
<pre><code>&quot;rule&quot;: &quot;$ADD_REQ_HEADER(X-From-Cdn, upyun)&quot;,
&quot;pattern&quot;: &quot;&quot;
</code></pre>
<p>规则释义：添加请求头 <code>X-From-Cdn:upyun</code>，识别 CDN 厂商。</p>
<pre><code>&quot;rule&quot;: &quot;$DEL_REQ_HEADER(Accept-Encoding) &quot;,
&quot;pattern&quot;: &quot;&quot;
</code></pre>
<p>规则释义：删除请求头 <code>Accept-Encoding</code> ，无论终端是否发起 <code>gzip</code> 的请求，都进行 <code>ungzip</code> 的返回。</p>
<p>示例二：添加响应头</p>
<pre><code>&quot;rule&quot;: &quot;$ADD_RSP_HEADER(CDN, UPYUN, 1) &quot;,
&quot;pattern&quot;: &quot;&quot;
</code></pre>
<p>规则释义：添加响应头 <code>CDN</code>  为 <code>UPYUN</code>, <code>1</code> 表示会覆盖掉已有的响应头，通过响应头也可以识别 CDN 厂商。</p>
<p><strong>5、URL 限速</strong></p>
<p>假如请求的 URL 为：<code>http://test.example.com/mp4/4E10F356C0FEAD359C33DC5901307461-10.mp4</code> ，需要对该类型文件进行限速，限速要求为：前 20MB 不限速，20MB 之后限速 800 KB/s，规则可这样编写：</p>
<pre><code>&quot;rule&quot;: &quot;$WHEN($1, $EQ($_HOST, 'test.example.com'))$LIMIT_RATE_AFTER(20, m)$LIMIT_RATE(800, k)&quot;,
&quot;pattern&quot;: &quot;^(/).+-10\.mp4$&quot;
</code></pre>
<p>规则释义：当 <code>$1</code> 为真，且满足请求 <code>HOST</code> 为 <code>test.example.com</code> 时 ，开始 20MB 不限速，后面限制到 <code>800KB/s</code>。</p>
<p><strong>6、大小写转换</strong></p>
<p>该部分会使用到<code>$LOWER(E)</code> 函数，直接看规则：</p>
<pre><code>&quot;rule&quot;: &quot;$WHEN($MATCH($LOWER($_URI), /uptest.png)) /UPtest.png&quot;,
&quot;pattern&quot;: &quot;&quot;
</code></pre>
<p>规则释义：首先是获取请求 <code>URI</code> ，使用 <code>$LOWER(E)</code> 函数将 <code>URI</code> 转换为小写，和 <code>/uptest.png</code> 进行匹配，匹配成功，则直接将 <code>URI</code> 改写为<code>/UPtest.png</code>。如果需要将字符串转换为大写，使用 <code>$UPPER(E)</code> 函数。</p>
<p><strong>7、数值比较</strong></p>
<p>也即将字符串或者数字进行比较。例如： <code>A</code> 和 <code>B</code> 进行比较，是否大于、大于等于、相等等逻辑，参见如下规则示例：</p>
<pre><code>&quot;rule&quot;: &quot;$GT($_TIME,$ADD($INT($_GET_t,16,10),3600))&quot;,
&quot;pattern&quot;: &quot;&quot;
</code></pre>
<p>规则释义：将请求 URL 中的 t 参数 由 16 进制转换为 10 进制，然后加上 3600 ，将相加得到的值和当前系统时间进行比较。这里使用到了 <code>$GT(E1，E2）</code> 函数，也即 <code>E1</code> 是否大于 <code>E2</code>，大于即返回 true 。另外，等于使用 <code>$EQ(E1，E2）</code> 函数，大于等于使用 <code>$GE(E1，E2）</code> 函数。</p>
<hr />
<p>如有疑问请 <a href="https://www.upyun.com/contact">联系我们</a></p>





                
              </article>
            </div>
          
          
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2017, 又拍云
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": [], "search": "../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.dff1b7c8.min.js"></script>
      
    
  </body>
</html>